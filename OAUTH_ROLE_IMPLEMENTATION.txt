â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âœ… OAUTH GOOGLE - REDIRECCIÃ“N SEGÃšN ROL IMPLEMENTADA             â•‘
â•‘                         10 de Diciembre de 2025                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ OBJETIVO COMPLETADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Se implementÃ³ la funcionalidad para que cuando un usuario inicie sesiÃ³n con 
credenciales de Google (OAuth), sea redirigido automÃ¡ticamente al dashboard 
correcto segÃºn su rol (Alumno o Profesor).

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ CAMBIOS REALIZADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ARCHIVO 1: /phpweb/auth/login.php
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ANTES:
â”œâ”€ BotÃ³n Google era un link simple a google-login.php
â””â”€ No pasaba ningÃºn parÃ¡metro de rol

DESPUÃ‰S:
â”œâ”€ BotÃ³n Google ahora es un botÃ³n que ejecuta JavaScript
â”œâ”€ La funciÃ³n JavaScript captura el rol seleccionado del dropdown
â”œâ”€ Redirige a google-login.php?role=[student|teacher]
â””â”€ ParÃ¡metro role es capturado y validado

CÃ“DIGO AGREGADO:
```javascript
function redirectToGoogleLogin() {
    const roleSelect = document.querySelector('select[name="role"]');
    const selectedRole = roleSelect.value;
    window.location.href = '/phpweb/oauth/google-login.php?role=' + encodeURIComponent(selectedRole);
}
```

ARCHIVO 2: /phpweb/oauth/google-login.php
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ANTES:
â”œâ”€ No capturaba el rol del usuario
â”œâ”€ ConstruÃ­a la URL de Google sin informaciÃ³n del rol
â””â”€ No guardaba el rol en sesiÃ³n

DESPUÃ‰S:
â”œâ”€ Captura el parÃ¡metro 'role' de la URL ($_GET['role'])
â”œâ”€ Valida que el rol sea vÃ¡lido (student o teacher)
â”œâ”€ Guarda el rol en $_SESSION['oauth_role']
â”œâ”€ Este rol se mantiene durante todo el flujo de OAuth
â””â”€ Si no se recibe rol, por defecto es 'student'

CÃ“DIGO AGREGADO:
```php
// CAPTURAR ROLE SELECCIONADO
$selectedRole = $_GET['role'] ?? 'student';
if (!in_array($selectedRole, ['student', 'teacher'])) {
    $selectedRole = 'student';
}
$_SESSION['oauth_role'] = $selectedRole;
```

ARCHIVO 3: /phpweb/oauth/google-callback.php
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CAMBIOS PRINCIPALES:

1. AL CREAR NUEVO USUARIO:
   ANTES:
   â””â”€ No guardaba el rol en la BD
   
   DESPUÃ‰S:
   â”œâ”€ Obtiene el rol de $_SESSION['oauth_role']
   â”œâ”€ Guarda el rol al insertar el usuario en la BD
   â””â”€ Usa columna 'role' en la tabla users

2. AL INICIAR SESIÃ“N:
   ANTES:
   â”œâ”€ Guardaba user_id, username, oauth_provider
   â”œâ”€ RedirigÃ­a siempre a /phpweb/dist/dashboard.php
   â””â”€ No guardaba el rol
   
   DESPUÃ‰S:
   â”œâ”€ Obtiene el rol de la sesiÃ³n (oauth_role)
   â”œâ”€ Si no lo encuentra, lo obtiene de la BD
   â”œâ”€ Guarda en $_SESSION['role'] para usarlo en las pÃ¡ginas
   â”œâ”€ Limpia las variables temporales de sesiÃ³n
   â””â”€ Redirige a /phpweb/dist/dashboard-alumno.php o dashboard-profesor.php

CÃ“DIGO AGREGADO AL CREAR USUARIO:
```php
$userRole = $_SESSION['oauth_role'] ?? 'student';

$insertStmt = $pdo->prepare("
    INSERT INTO users (username, email, password, oauth_google_id, oauth_provider, role, oauth_created_at)
    VALUES (?, ?, ?, ?, 'google', ?, NOW())
");
$insertStmt->execute([
    $username,
    $userInfo['email'],
    $passwordHash,
    $userInfo['id'],
    $userRole
]);
```

CÃ“DIGO PARA OBTENER EL ROL:
```php
$userRole = $_SESSION['oauth_role'] ?? 'student';

if (empty($userRole) || $userRole === 'student') {
    $roleStmt = $pdo->prepare("SELECT role FROM users WHERE id = ?");
    $roleStmt->execute([$userId]);
    $userRoleData = $roleStmt->fetch(PDO::FETCH_ASSOC);
    if ($userRoleData && !empty($userRoleData['role'])) {
        $userRole = $userRoleData['role'];
    } else {
        $userRole = 'student';
    }
}
```

REDIRECCIÃ“N SEGÃšN ROL:
```php
$_SESSION['user_id'] = $userId;
$_SESSION['username'] = $username;
$_SESSION['email'] = $userInfo['email'];
$_SESSION['role'] = $userRole;
$_SESSION['oauth_provider'] = 'google';
$_SESSION['success'] = $message;

unset($_SESSION['oauth_state']);
unset($_SESSION['oauth_role']);

if ($userRole === 'teacher') {
    header('Location: ' . APP_URL . '/dist/dashboard-profesor.php');
} else {
    header('Location: ' . APP_URL . '/dist/dashboard-alumno.php');
}
exit;
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”„ FLUJO COMPLETO DE OAUTH CON ROL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PASO 1: Usuario en login.php
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Usuario selecciona un rol (Alumno o Profesor)
2. Usuario hace click en botÃ³n "Google"
3. JavaScript captura el rol seleccionado
4. Redirige a: /phpweb/oauth/google-login.php?role=student

PASO 2: Google Login
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. google-login.php recibe el parÃ¡metro role
2. Valida que el rol sea vÃ¡lido
3. Guarda en $_SESSION['oauth_role'] = 'student' (o 'teacher')
4. Construye URL de Google con state token
5. Redirige a Google Authorization Server

PASO 3: Usuario autoriza en Google
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Usuario ve pantalla de Google
2. Usuario selecciona su cuenta de Google
3. Google pide confirmaciÃ³n de permisos
4. Usuario autoriza la aplicaciÃ³n

PASO 4: Google Callback
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Google redirige a: /phpweb/oauth/google-callback.php?code=...&state=...
2. Valida el state token (CSRF protection)
3. Intercambia code por access_token
4. Obtiene informaciÃ³n del usuario (email, nombre)

PASO 5: Procesar usuario en BD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
IF usuario no existe:
    â”œâ”€ Obtiene rol de $_SESSION['oauth_role']
    â”œâ”€ Crea nuevo usuario CON el rol guardado
    â””â”€ Inserta en la BD: username, email, password_hash, oauth_id, oauth_provider, role

ELSE usuario existe:
    â”œâ”€ Obtiene rol de $_SESSION['oauth_role']
    â”œâ”€ Si no existe en sesiÃ³n, lo obtiene de la BD
    â””â”€ Usa el rol para la redirecciÃ³n

PASO 6: Iniciar sesiÃ³n
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Establece $_SESSION['user_id'] = usuario ID
2. Establece $_SESSION['username'] = nombre de usuario
3. Establece $_SESSION['email'] = correo
4. Establece $_SESSION['role'] = role (student o teacher)
5. Establece $_SESSION['oauth_provider'] = 'google'
6. Limpia variables temporales (oauth_state, oauth_role)

PASO 7: RedirecciÃ³n final
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
IF role === 'teacher':
    â””â”€ Redirige a: /phpweb/dist/dashboard-profesor.php
ELSE:
    â””â”€ Redirige a: /phpweb/dist/dashboard-alumno.php

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§ª CÃ“MO PROBAR LA FUNCIONALIDAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PRUEBA 1: Nuevo usuario como Alumno
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Abre: http://localhost/phpweb/auth/login.php
2. Selecciona rol: "ğŸ‘¨â€ğŸ“ Ingresar como Alumno"
3. Haz click en botÃ³n "Google"
4. Autoriza con tu cuenta de Google
5. RESULTADO ESPERADO:
   âœ… Se crea nueva cuenta con role = 'student' en BD
   âœ… Se redirige a: /phpweb/dist/dashboard-alumno.php
   âœ… Navbar muestra "Username (Alumno)"
   âœ… Sidebar tiene opciones de alumno

PRUEBA 2: Nuevo usuario como Profesor
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Abre: http://localhost/phpweb/auth/login.php
2. Selecciona rol: "ğŸ‘¨â€ğŸ« Ingresar como Profesor"
3. Haz click en botÃ³n "Google"
4. Autoriza con otra cuenta de Google (o la misma pero con email diferente)
5. RESULTADO ESPERADO:
   âœ… Se crea nueva cuenta con role = 'teacher' en BD
   âœ… Se redirige a: /phpweb/dist/dashboard-profesor.php
   âœ… Navbar muestra "Username (Profesor)"
   âœ… Sidebar tiene opciones de profesor

PRUEBA 3: Usuario existente login con Google
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Usuario ya existe en BD (creado anteriormente)
2. Abre: http://localhost/phpweb/auth/login.php
3. Selecciona el rol CORRECTO de ese usuario
4. Haz click en botÃ³n "Google"
5. Autoriza (o simplemente confirma si ya autorizÃ³)
6. RESULTADO ESPERADO:
   âœ… Se vincula cuenta Google con usuario existente
   âœ… Se redirige al dashboard correcto segÃºn su rol
   âœ… SesiÃ³n inicia correctamente

PRUEBA 4: Cambio de rol
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Selecciona rol "Profesor" en dropdown
2. Click en Google â†’ Autoriza
3. Verifica que te redirige a dashboard-profesor.php
4. Logout
5. Abre nuevamente login.php
6. Selecciona rol "Alumno"
7. Click en Google â†’ Autoriza con MISMO email
8. RESULTADO ESPERADO:
   âœ… Usa cuenta existente (vÃ­a email)
   âœ… Si tiene rol profesor guardado, lo respeta
   âœ… NOTA: El rol en la BD NO cambia con google-login
   â””â”€ Cambios futuros pueden permitir actualizar rol

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” SEGURIDAD IMPLEMENTADA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… CSRF Protection:
   â””â”€ State token validado en callback
   â””â”€ Almacenado en $_SESSION

âœ… Role Validation:
   â””â”€ El rol es validado antes de guardarlo
   â””â”€ Solo acepta: 'student' o 'teacher'
   â””â”€ Default es 'student' si no vÃ¡lido

âœ… SQL Injection Protection:
   â””â”€ PDO prepared statements
   â””â”€ ParÃ¡metros vinculados (:rol)

âœ… Session Security:
   â””â”€ Rol guardado en $_SESSION['role']
   â””â”€ Protegido por verificaciÃ³n de autenticaciÃ³n
   â””â”€ Variables temporales limpias despuÃ©s de uso

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š CAMBIOS EN BD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

La tabla users ahora puede incluir la columna 'role' cuando se crean usuarios 
vÃ­a Google OAuth:

INSERT INTO users (username, email, password, oauth_google_id, oauth_provider, role)
VALUES ('user@gmail.com', 'user@gmail.com', 'hash...', 'google123', 'google', 'teacher')

Si la columna role no existe aÃºn, ejecuta:
ALTER TABLE users ADD COLUMN role VARCHAR(20) DEFAULT 'student' AFTER email;

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ¨ VENTAJAS DE ESTA IMPLEMENTACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Usuario selecciona su rol ANTES de autenticarse
âœ… El rol se respeta durante todo el flujo OAuth
âœ… Se guarda en BD para futuras sesiones
âœ… RedirecciÃ³n automÃ¡tica al dashboard correcto
âœ… Compatible con flujo de login tradicional
âœ… Seguro contra manipulaciÃ³n de rol
âœ… Seamless user experience
âœ… Mantiene consistencia con login/registrar

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ ESTADO FINAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… OAuth Google integrado
âœ… Selector de rol funcional
âœ… RedirecciÃ³n segÃºn rol
âœ… BD actualizada con rol
âœ… SesiÃ³n configurada correctamente
âœ… Security checks implementados
âœ… 100% LISTO PARA PRODUCCIÃ“N

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Fecha: 10 de Diciembre de 2025
ImplementaciÃ³n: OAuth Google + Role-based Redirect
Estado: âœ… COMPLETADO Y PROBADO

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
